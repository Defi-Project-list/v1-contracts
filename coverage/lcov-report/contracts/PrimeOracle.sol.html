<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\PrimeOracle.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> PrimeOracle.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">94.59% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>35/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>8/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.22% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>35/36</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">316×</span>
<span class="cline-any cline-yes">316×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">316×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">316×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1629×</span>
<span class="cline-any cline-yes">1629×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1629×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">354×</span>
<span class="cline-any cline-yes">354×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">320×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">354×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">354×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">354×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">318×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-yes">347×</span>
<span class="cline-any cline-yes">4631×</span>
<span class="cline-any cline-yes">4631×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.6.2;
&nbsp;
/**
 * @title   Oracle for Calculating The Prices of Prime Options
 * @author  Primitive
 */
&nbsp;
import "@openzeppelin/contracts/math/SafeMath.sol";
&nbsp;
interface PriceOracleProxy {
    function getUnderlyingPrice(address cToken) external view returns (uint);
}
&nbsp;
contract PrimeOracle {
    using SafeMath for uint256;
&nbsp;
    address public constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address public constant MCD_DAI = 0x6B175474E89094C44Da98b954EedeAC495271d0F;
    address public constant COMPOUND_DAI = 0x5d3a536E4D6DbD6114cc1Ead35777bAB948E3643;
    address public constant COMPOUND_ETH = 0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5;
    address public constant COMPOUND_USDC = 0x39AA39c021dfbaE8faC545936693aC917d5E7563;
    address public constant COMPOUND_USDT = 0xf650C3d88D12dB855b8bf7D11Be6C55A4e07dCC9;
    address public constant COMPOUND_WBTC = 0xC11b1268C1A384e55C48c2391d8d480264A3A7F4;
    address public oracle;
&nbsp;
    uint256 public constant MIN_PREMIUM = 10**3;
    uint256 public constant ONE_ETHER = 1 ether;
    uint256 public constant SECONDS_IN_DAY = 86400;
    uint256 public constant MANTISSA = 10**36;
&nbsp;
    mapping(address =&gt; address) public feeds;
&nbsp;
    constructor(address _oracle) public {
        oracle = _oracle;
        feeds[MCD_DAI] = COMPOUND_DAI;
    }
&nbsp;
    /**
     * @dev Testing function to add non-mainnet oracle feeds.
     */
    function addFeed(address feed) public {
        feeds[feed] = feed;
    }
&nbsp;
    /**
     * @dev Calculates the intrinsic + extrinsic value of the Prime option.
     * @notice Strike / Market * (Volatility * 1000) * sqrt(T in seconds remaining) / Seconds in a Day.
     * @param tokenU The address of the underlying asset.
     * @param tokenS The address of the strike asset.
     * @param volatility The arbritary volatility as a percentage scaled by 1000.
     * @param base The quantity of the underlying asset. Also the price of tokenU denomined in tokenU.
     * @param price The quantity of the strike asset. Also the price of tokenU denominated in tokenS.
     * @param expiry The expirate date (strike date) of the Prime option as a UNIX timestamp.
     * @return premium The sum of the 'time value' and 'intrinsic' value of the Prime option.
     * Returns a premium that is denominated in tokenU.
     */
    function calculatePremium(
        address tokenU,
        address tokenS,
        uint256 volatility,
        uint256 base,
        uint256 price,
        uint256 expiry
    )
        public
        view
        returns (uint256 premium)
    {
        // Calculate the parts.
        (uint256 intrinsic) = calculateIntrinsic(tokenU, tokenS, base, price);
        (uint256 extrinsic) = calculateExtrinsic(tokenU, tokenS, volatility, base, price, expiry);
        
        // Sum the parts.
        premium = (extrinsic.add(intrinsic));
&nbsp;
        // If the premium is 0, return a minimum value.
        premium = premium &gt; 0 ? premium : MIN_PREMIUM;
    }
&nbsp;
    /**
     * @dev Gets the market price of tokenU using compound's oracle, which uses the compound
     * version of the token.
     */
    function marketPrice(address token) public view returns (uint256 market) {
        // The compound wrapped cToken. e.g. cToken = DAI, feed = cDAI.
        address feed = feeds[token];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(feed != address(0), "ERR_FEED_INVALID");
        // Returns the price of cToken denominated in ethers.
        market = PriceOracleProxy(oracle).getUnderlyingPrice(feed);
    }
&nbsp;
    /**
     * @dev Calculates the intrinsic value of a Prime option using compound's price oracle.
     * @param tokenU The address of the underlying asset.
     * @param tokenS The address of the strike asset.
     * @param base The quantity of the underlying asset. Also the price of tokenU denomined in tokenU.
     * @param price The quantity of the strike asset. Also the price of tokenU denominated in tokenS.
     * @return intrinsic The difference between the price of tokenU denominated in S between the
     * strike price (price) and market price (market).
     */
    function calculateIntrinsic(address tokenU, address tokenS, uint256 base, uint256 price)
        public
        view
        returns (uint256 intrinsic)
    {
        // Get the oracle market price.
        uint256 market;
        if(tokenU == WETH) {
            // Market price of tokenU per tokenS.
            (market) = marketPrice(tokenS);
            // Convert tokenU per tokenS to tokenS per tokenU. Assumes oracle never returns a value &gt; 1e36.
            market = MANTISSA.div(market);
        } else {
            // Market price of tokenS per tokenU.
            (market) = marketPrice(tokenU);
        }
        // Strike price of tokenU per tokenS. Scaled to 10^18 units.
        uint256 strike = price.mul(ONE_ETHER).div(base);
        // Intrinsic value denominated in tokenS per tokenU.
        intrinsic = market &gt; strike ? market.sub(strike) : 0; 
        // Convert units back to tokenU per tokenS.
        intrinsic = intrinsic.mul(base).div(market);
    }
&nbsp;
    /**
     * @dev Calculates the extrinsic value of the Prime option using Primitive's pricing model.
     * @notice Strike / Market * (Volatility(%) * 1000) * sqrt(T in seconds left) / Seconds in a Day.
     * @param tokenU The address of the underlying asset.
     * @param tokenS The address of the strike asset.
     * @param volatility The arbritary volatility as a percentage scaled by 1000.
     * @param base The quantity of the underlying asset. Also the price of tokenU denomined in tokenU.
     * @param price The quantity of the strike asset. Also the price of tokenU denominated in tokenS.
     * @param expiry The expirate date (strike date) of the Prime option as a UNIX timestamp.
     * @return extrinsic The 'time value' of the Prime option based on Primitive's pricing model.
     */
    function calculateExtrinsic(
        address tokenU,
        address tokenS,
        uint256 volatility,
        uint256 base,
        uint256 price,
        uint256 expiry
    )
        public
        view
        returns (uint256 extrinsic)
    {
        // Get the oracle market price.
        uint256 market;
        if(tokenU == WETH) {
            // Market price of tokenU per tokenS.
            (market) = marketPrice(tokenS);
            // Convert tokenU per tokenS to tokenS per tokenU. Assumes oracle never returns a value &gt; 1e36.
            market = MANTISSA.div(market);
        } else {
            // Market price of tokenS per tokenU.
            (market) = marketPrice(tokenU);
        }
        
        // Time left in seconds.
        uint256 timeRemainder = (expiry.sub(block.timestamp));
        // Strike price is the price of tokenU denominated in tokenS.
        uint256 strike = price.mul(ONE_ETHER).div(base);
        // Strike / Market scaled to 1e18. Denominated in ethers.
        /* uint256 moneyness = strike.mul(ONE_ETHER).div(market); */
        uint256 moneyness = market.mul(ONE_ETHER).div(strike);
        // Extrinsic value denominted in tokenU.
        extrinsic = moneyness
                            .mul(ONE_ETHER)
                            .mul(volatility)
                            .mul(sqrt(timeRemainder))
                                .div(ONE_ETHER)
                                .div(SECONDS_IN_DAY);
        if(tokenU == WETH) {
            // Convert units back to tokenU per tokenS.
            // Extrinsic calculation is always in DAI per ETH, but if tokenU is ETH
            // we want the price in ETH per DAI.
            extrinsic = extrinsic.mul(base).div(market);
        }
    }
&nbsp;
    /**
     * @dev Utility function to calculate the square root of an integer. Used in calculating premium.
     */
    function sqrt(uint256 y) private pure returns (uint256 z) {
        <span class="missing-if-branch" title="else path not taken" >E</span>if (y &gt; 3) {
            uint256 x = (y + 1) / 2;
            z = y;
            while (x &lt; z) {
                z = x;
                x = (y / x + x) / 2;
            }
        } else <span class="cstat-no" title="statement not covered" >if (y != 0) {</span>
<span class="cstat-no" title="statement not covered" >            z = 1</span>;
        }
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed May 13 2020 10:40:30 GMT-0700 (Pacific Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
